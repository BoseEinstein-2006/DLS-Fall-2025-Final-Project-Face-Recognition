# DLS-Fall-2025-Final-Project-Face-Recognition

В этом репрезитории собраны ноутбуки, которые я использовал для финального проекта по Face Recognition для DLS по курсу Deep Learning (семестр 1, весна 2025).

**!!! Все inputs/outputs для различных шагов я положил на свой Google Drive здесь: !!!**

https://drive.google.com/drive/folders/1irpKd4v7R_AUPHtrwKsynkvGED7B12K9?usp=sharing

# Основные задания

## Шаг 0: предварительный анализ данных

**0_Data_analysis.ipynb**

В этом ноутбуке я сделал быстренький анализ данных, покрутил их туда-сюда. Этот ноутбук я использовал локально на своем компьютере.

Получилось достаточно сумбурно, но что есть.

**Inputs:** 

1) папка "archive" с изображениями и файлами "list_attr_celeba.csv", "list_bbox_celeba.csv", скаченными отсюда:

https://www.kaggle.com/datasets/kevinpatel04/celeba-original-wild-images

2) "list_landmarks_celeba.txt" и "identity_CelebA.txt", скачены отсюда:

https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html

**Outputs:** 

Нет

**Описание и Выводы:**

1) Распределение картинок по аттрибутам выглядит разумным, типа Male около 50%, мало с очками и шляпами и прочее
2) Картинки с Blurry можно все выкинуть, их немного
3) Есть куча (>3k) identities c количеством изображений больше 25, так что есть из чего выбирать для обучения
4) Можно выкинуть картинки с слишком маленькими bbox
5) Сами bbox можно уменьшить на 5% процентов, чтобы захватить чисто лицо

## Шаг 1: подготовка данных для Stacked Hourglass

**1_Data_preparation.ipynb**

В этом ноутбуке я выбираю картинки на которых буду обучать Stacked Hourglass на следующем шаге. Этот ноутбук я использовал локально на своем компьютере.

**Inputs:** 

1) папка "archive" с изображениями и файлами "list_attr_celeba.csv", "list_bbox_celeba.csv", скаченными отсюда:

https://www.kaggle.com/datasets/kevinpatel04/celeba-original-wild-images

2) "list_landmarks_celeba.txt" и "identity_CelebA.txt", скачены отсюда:

https://mmlab.ie.cuhk.edu.hk/projects/CelebA.html

**Outputs:**

1) папка data-for-alignment с отобранными картинками и "selected_images.csv", где записаны image_id, attrbiutes и прочее для отобранных картинок

**Описание и Выводы:**

1) Избавляемся от всех картинок с Blurry == 1 и bbox меньше заданных минимальных размеров. Из оставшихся картинок будем выбирать данные для следущего Шага.
2) Для FaceRecognition важно чтобы на каждую identity было достаточно изображений, поэтому надо выбирать identity с достаточным количеством картинок. 
3) Я чуть поэкспериментировал и остановился на том, что надо 25 картинок на каждую identity. При этом было хорошо иметь много разных identities, например 1000.
4) Итого выбирает 1000 identities с 25 картинок на каждую identity = 25000 изображений для следущего Шага.
5) По хорошему надо бы сверху еще докинуть фильтров, что бы в конечной выборке было например 50% мужчин, 5% с очками, 5% с шапками и прочим. Я изначально так и делал, но потом я не заметил чтобы это как-то изменило метрики для выравливания или распознования. Так что в финальной версии я все это выкинул и выбирал 25000 картинок лишь по identites.

## Шаг 2: тренировка Stacked Hourglass

**2_Face_alignment.ipynb**

В этом ноутбуке я обучаю Stacked Hourglass. Этот ноутбук я использовал на Каггле, на GPU T4 x2 заняло порядка 4 часов.

**Inputs:** 

С Шага 1 берем:

1) папку data-for-alignment с отобранными картинками и "selected_images.csv", где записаны image_id, attrbiutes и прочее для отобранных картинок

**Outputs:**

1) папка data-for-recognition c выровненными картинки, "aligned_pred_all.csv" с image_id и identiry и best_stacked_hg.pth с лучшими весами для Stacked Hourglass

**Описание и Выводы:**

1) Берем картинки из selected images, обрезаем их по bbox с уменьшенным на 5% маржином, потом приводим их к одному размеру и обучаем на них Stacked Hourglass
2) Потом применяем к картинкам аффинное преобразование, чтобы выровнять их
3) Проходим по всем картинкам и из выровненные версии сохваняем в results_alignment для шага 3
4) лучший NME на тесте 0.037

## Шаг 3: распознование на CE и Arcface

**3_Face_recognition.ipynb**

В этом ноутбуке я обучаю ceтку распозновать лица на CE и Arcface. Этот ноутбук я использовал на Каггле, на GPU T4 x2 заняло порядка 3 часов.

**Inputs:** 

С Шага 2 берем:

1) папку data-for-recognition c выровненными картинки, "aligned_pred_all.csv" с image_id и identiry

**Outputs:**

1) best_af.pth с лучшими весами для модели с Arcface

**Описание и Выводы:**

1) Берем картинки из data-for-recognition и обучаем на них модель с CE и Arcface
2) На тесте best accuracy для СE: 0.89, а для Arcface 0.93
3) В задании бьло написано "Написать небольшой отчет по обучению, сравнить CE loss и ArcFace loss", но я если честно не знаю, что тут писать кроме каких-то общих слов. я построил t-SNE, гистограммы для cosine similarity и ROC для СE и Arcface. И везде Arcface показывает ожидаемые результаты:
   - Accuracy на тесте для начальных эпох ниже чем val accuracy. Это из-за используемой маржи, она усложняет обучение. На более поздних эпохах разница межну train accuracy и val accuracy становится меньше чем для CE loss, что указывает на лучшую обобщающую способность Arcface
   - На t-SNE для ArcFace видно что точки одного класса группируются компактнее и разные классы лучше отделены друг от друга
   - Для ArcFace распределение cosine similarity для inter class имеет медиану 0, то есть разные классы хорошо разведены и в среднем ортогональны. Так же пересечение распределений cosine similarity для inter class и intra class для Arcface заметно меньше чем для CE
   - AUC для ArcFace так же выше чем у CE
     
## Шаг 4: испытываем пайплайн

**4_Pipeline_test.ipynb**

В этой ноутбуке я тесчу пайплайн. Этот ноутбук я использовал на Каггле, на GPU T4 x2 заняло порядка 1 минуты.

**Inputs:** 

1) pipeline.py - сюда я закинул Stacked Hourglass и Arcface модули и написал сам код для Pipeline
2) best_stacked_hg.pth и best_af.pth - веса лучших моделей с предыдущих шагов
3) images-to-test-pipeline - картинки на которых будем тестить

**Outputs:** 

Нет

**Описание и Выводы:**

На мой взгляд получилось неплохо, учитывая простоту моделей. Cosine similarity на большинстве картинок конечно невысокая, но референс уверенно попадает в топ1, поэтому пайплайн работает.
